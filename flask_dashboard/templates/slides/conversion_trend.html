<!-- Slide 6: Conversion Trend -->
<div class="page-header">
    <h1 class="page-title">Conversion Rate Trends</h1>
    <p class="page-subtitle">Weekly calls done vs purchase rate trends</p>
    <div class="date-badge">
        <span>{{ start_display }} - {{ end_display }}</span>
    </div>
</div>

{% if trend and trend|length > 0 %}
<!-- Summary Metrics -->
<div class="metrics-grid">
    <div class="metric-card highlight">
        <div class="metric-icon">&#128222;</div>
        <div class="metric-label">Total Calls</div>
        <div class="metric-value">{{ trend|map(attribute='calls_done')|sum }}</div>
    </div>

    <div class="metric-card">
        <div class="metric-icon green">&#128176;</div>
        <div class="metric-label">Total Purchases</div>
        <div class="metric-value">{{ trend|map(attribute='purchases')|sum }}</div>
    </div>

    <div class="metric-card">
        <div class="metric-icon orange">&#128200;</div>
        <div class="metric-label">Avg Conversion</div>
        <div class="metric-value">{{ (trend|map(attribute='purchase_rate')|sum / trend|length)|round(1) }}%</div>
    </div>

    <div class="metric-card">
        <div class="metric-icon blue">&#128197;</div>
        <div class="metric-label">Weeks Analyzed</div>
        <div class="metric-value">{{ trend|length }}</div>
    </div>
</div>

<!-- Dual Axis Chart -->
<div class="chart-container">
    <div class="chart-header">Weekly Calls Done vs Purchase Rate Trends</div>
    <div id="conversion-trend-chart"></div>
</div>

<!-- Data Table -->
<div class="card">
    <div class="card-header">
        <span>&#128202;</span> Detailed Conversion Data
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Week</th>
                    <th>Calls Done</th>
                    <th>Purchases</th>
                    <th>Purchase Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for t in trend %}
                <tr>
                    <td><strong>{{ t.week }}</strong></td>
                    <td>{{ t.calls_done }}</td>
                    <td>{{ t.purchases }}</td>
                    <td>{{ t.purchase_rate }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
var conversionTrendOptions = {
    series: [
        {
            name: 'Calls Done',
            type: 'column',
            data: [{% for t in trend %}{{ t.calls_done }}{% if not loop.last %}, {% endif %}{% endfor %}]
        },
        {
            name: 'Purchase Rate',
            type: 'line',
            data: [{% for t in trend %}{{ t.purchase_rate }}{% if not loop.last %}, {% endif %}{% endfor %}]
        }
    ],
    chart: { height: 400, type: 'line', toolbar: { show: false } },
    stroke: { width: [0, 3], curve: 'smooth' },
    colors: ['#6366f1', '#f97316'],
    plotOptions: {
        bar: { borderRadius: 6, columnWidth: '60%' }
    },
    fill: {
        opacity: [1, 1]
    },
    markers: { size: [0, 6] },
    xaxis: {
        categories: [{% for t in trend %}'{{ t.week }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        labels: { rotate: -45 }
    },
    yaxis: [
        {
            title: { text: 'Calls Done' }
        },
        {
            opposite: true,
            title: { text: 'Purchase Rate (%)' },
            labels: { formatter: function(val) { return val + '%'; } }
        }
    ],
    legend: { position: 'top' },
    dataLabels: {
        enabled: true,
        enabledOnSeries: [0, 1],
        formatter: function(val, { seriesIndex }) {
            return seriesIndex === 1 ? val + '%' : val;
        }
    }
};
new ApexCharts(document.getElementById('conversion-trend-chart'), conversionTrendOptions).render();
</script>
{% else %}
<div class="empty-state">
    <div class="empty-state-icon">&#128200;</div>
    <h3>No Data Available</h3>
    <p>No conversion trend data found for the selected date range.</p>
</div>
{% endif %}
