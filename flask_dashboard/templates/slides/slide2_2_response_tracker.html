<!-- Slide 2.2: Response Rate Tracker -->
<h2 class="page-title">Slide 2.2: Response Rate Tracker</h2>

<div class="alert-banner" style="background: #dbeafe; border-color: #3b82f6; color: #1e40af;">
    <span>&#128197;</span> Analysis Period: {{ start_date }} to {{ end_date }}
</div>

<div class="alert-banner" style="background: #fef3c7; border-color: #fcd34d; color: #92400e;">
    <span>&#9888;&#65039;</span> Note: Source 'Inbound_Direct' is excluded from all metrics on this slide
</div>

<!-- Tabs Container -->
<div class="tabs-container">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('overview')">Response Overview</button>
        <button class="tab-btn" onclick="switchTab('daily')">Daily Response</button>
        <button class="tab-btn" onclick="switchTab('agent')">Agent Data</button>
        <button class="tab-btn" onclick="switchTab('model')">Model Accuracy</button>
        <button class="tab-btn" onclick="switchTab('blank')">Blank Response</button>
    </div>

    <!-- Tab 1: Response Overview -->
    <div id="tab-overview" class="tab-content active">
        {% if metrics %}
        <h3 style="margin: 16px 0; font-size: 1rem; color: #1e293b;">Response Overview Metrics</h3>

        <!-- Row 1: Main metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Calls Booked</div>
                <div class="metric-value">{{ metrics.calls_booked }}</div>
                <div style="font-size: 0.7rem; color: #94a3b8;">Total calls (excl. Inbound_Direct)</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Responses Received (Yes)</div>
                <div class="metric-value">{{ metrics.responses_yes }}</div>
                <div style="font-size: 0.7rem; color: #94a3b8;">Done OR WhatsApp: In Touch/Confirmed</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Response Rate</div>
                <div class="metric-value">{{ metrics.response_rate }}%</div>
                <div style="font-size: 0.7rem; color: #94a3b8;">Yes / Calls Booked</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Blanks</div>
                <div class="metric-value">{{ metrics.responses_blank }}</div>
                <div style="font-size: 0.7rem; color: #94a3b8;">No response recorded</div>
            </div>
        </div>

        <!-- Row 2: Attendance metrics -->
        <div class="metrics-grid" style="margin-top: 16px;">
            <div class="metric-card">
                <div class="metric-label">Calls Done</div>
                <div class="metric-value">{{ metrics.calls_done }}</div>
                <div style="font-size: 0.7rem; color: #94a3b8;">Call_Status = 'Done'</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Attendance Rate</div>
                <div class="metric-value">{{ metrics.attendance_rate }}%</div>
                <div style="font-size: 0.7rem; color: #94a3b8;">Calls Done / Calls Booked</div>
            </div>
        </div>

        <!-- Response Summary Table -->
        <h3 style="margin: 24px 0 16px 0; font-size: 1rem; color: #1e293b;">Response Summary Table</h3>

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                            <th>Definition</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Calls Booked</td><td>{{ metrics.calls_booked }}</td><td>-</td></tr>
                        <tr><td>Responses (Yes)</td><td>{{ metrics.responses_yes }}</td><td>Call Done OR WhatsApp: In Touch/Confirmed Attendance</td></tr>
                        <tr><td>Responses (No)</td><td>{{ metrics.responses_no }}</td><td>WhatsApp: No Response</td></tr>
                        <tr><td>Blanks</td><td>{{ metrics.responses_blank }}</td><td>No response recorded</td></tr>
                        <tr><td>Response Rate</td><td>{{ metrics.response_rate }}%</td><td>Yes / Calls Booked</td></tr>
                        <tr><td>Calls Done</td><td>{{ metrics.calls_done }}</td><td>Call_Status = 'Done'</td></tr>
                        <tr><td>Attendance Rate</td><td>{{ metrics.attendance_rate }}%</td><td>Calls Done / Calls Booked</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Response Distribution Chart -->
        <h3 style="margin: 24px 0 16px 0; font-size: 1rem; color: #1e293b;">Response Distribution</h3>
        <div class="chart-container">
            <div id="response-pie-chart"></div>
        </div>

        <script>
        var responsePieOptions = {
            series: [{{ metrics.responses_yes }}, {{ metrics.responses_no }}, {{ metrics.responses_blank }}],
            chart: { type: 'pie', height: 400 },
            labels: ['Yes', 'No', 'Blank'],
            colors: ['#10b981', '#f97316', '#94a3b8'],
            legend: { position: 'bottom' },
            dataLabels: {
                enabled: true,
                formatter: function(val, opts) {
                    return opts.w.config.series[opts.seriesIndex] + ' (' + val.toFixed(1) + '%)';
                }
            }
        };
        new ApexCharts(document.getElementById('response-pie-chart'), responsePieOptions).render();
        </script>
        {% else %}
        <div class="empty-state">
            <p>No data available for the selected date range (after excluding Inbound_Direct).</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab 2: Daily Response -->
    <div id="tab-daily" class="tab-content">
        {% if daily and daily|length > 0 %}
        <h3 style="margin: 16px 0; font-size: 1rem; color: #1e293b;">Daily Response Metrics Table</h3>

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Calls Booked</th>
                            <th>Responded</th>
                            <th>Response Rate</th>
                            <th>Calls Done</th>
                            <th>Attendance Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in daily %}
                        <tr>
                            <td>{{ d.date }}</td>
                            <td>{{ d.calls_booked }}</td>
                            <td>{{ d.responded }}</td>
                            <td>{{ d.response_rate }}%</td>
                            <td>{{ d.calls_done }}</td>
                            <td>{{ d.attendance_rate }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Daily Trend Chart -->
        <h3 style="margin: 24px 0 16px 0; font-size: 1rem; color: #1e293b;">Daily Trend Chart</h3>
        <div class="chart-container">
            <div id="daily-trend-chart"></div>
        </div>

        <script>
        var dailyTrendOptions = {
            series: [
                { name: 'Calls Booked', type: 'line', data: [{% for d in daily %}{{ d.calls_booked }}{% if not loop.last %}, {% endif %}{% endfor %}] },
                { name: 'Response Rate (%)', type: 'line', data: [{% for d in daily %}{{ d.response_rate }}{% if not loop.last %}, {% endif %}{% endfor %}] },
                { name: 'Attendance Rate (%)', type: 'line', data: [{% for d in daily %}{{ d.attendance_rate }}{% if not loop.last %}, {% endif %}{% endfor %}] }
            ],
            chart: { height: 400, type: 'line', toolbar: { show: false } },
            stroke: { curve: 'smooth', width: 3 },
            colors: ['#6366f1', '#10b981', '#f97316'],
            markers: { size: 6 },
            xaxis: {
                categories: [{% for d in daily %}'{{ d.date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                labels: { rotate: -45 }
            },
            yaxis: [
                { title: { text: 'Calls Booked' } },
                { opposite: true, title: { text: 'Rate (%)' }, max: 100 }
            ],
            legend: { position: 'top' }
        };
        new ApexCharts(document.getElementById('daily-trend-chart'), dailyTrendOptions).render();
        </script>
        {% else %}
        <div class="empty-state">
            <p>No daily data available for the selected date range.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab 3: Agent Data -->
    <div id="tab-agent" class="tab-content">
        {% if agents and agents|length > 0 %}
        <h3 style="margin: 16px 0; font-size: 1rem; color: #1e293b;">Agent Response Data</h3>
        <p style="color: #64748b; margin-bottom: 16px;">Select an agent to view their response metrics:</p>

        <div class="agent-grid">
            {% for a in agents %}
            <button class="agent-btn" data-agent="{{ a.agent }}" onclick="selectAgent('{{ a.agent }}')">{{ a.agent }}</button>
            {% endfor %}
        </div>

        <!-- Agent Summary Table (shows all agents) -->
        <div class="card" style="margin-top: 24px;">
            <div class="card-header">All Agents Summary</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Agent</th>
                            <th>Calls Booked</th>
                            <th>Yes</th>
                            <th>No</th>
                            <th>Blank</th>
                            <th>Response Rate</th>
                            <th>Calls Done</th>
                            <th>Attendance Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in agents %}
                        <tr>
                            <td>{{ a.agent }}</td>
                            <td>{{ a.calls_booked }}</td>
                            <td>{{ a.responses_yes }}</td>
                            <td>{{ a.responses_no }}</td>
                            <td>{{ a.responses_blank }}</td>
                            <td>{{ a.response_rate }}%</td>
                            <td>{{ a.calls_done }}</td>
                            <td>{{ a.attendance_rate }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="agent-detail" style="display: none; margin-top: 24px;">
            <div class="card">
                <div class="card-header"><span id="agent-name-display">Agent</span> - Response Summary</div>
                <div id="agent-summary-content" style="padding: 16px;"></div>
            </div>
        </div>

        <script>
        var agentData = {
            {% for a in agents %}
            '{{ a.agent }}': {
                calls_booked: {{ a.calls_booked }},
                yes: {{ a.responses_yes }},
                no: {{ a.responses_no }},
                blank: {{ a.responses_blank }},
                response_rate: {{ a.response_rate }},
                calls_done: {{ a.calls_done }},
                attendance_rate: {{ a.attendance_rate }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        };

        function renderAgentData(agent) {
            var data = agentData[agent];
            document.getElementById('agent-name-display').textContent = agent;
            var html = '<table style="width:100%">' +
                '<tr><td>Calls Booked</td><td>' + data.calls_booked + '</td></tr>' +
                '<tr><td>Responses (Yes)</td><td>' + data.yes + '</td></tr>' +
                '<tr><td>Responses (No)</td><td>' + data.no + '</td></tr>' +
                '<tr><td>Blanks</td><td>' + data.blank + '</td></tr>' +
                '<tr><td>Response Rate</td><td>' + data.response_rate + '%</td></tr>' +
                '<tr><td>Calls Done</td><td>' + data.calls_done + '</td></tr>' +
                '<tr><td>Attendance Rate</td><td>' + data.attendance_rate + '%</td></tr>' +
                '</table>';
            document.getElementById('agent-summary-content').innerHTML = html;
        }
        </script>
        {% else %}
        <div class="empty-state">
            <p>No agents found for the selected date range.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab 4: Model Accuracy -->
    <div id="tab-model" class="tab-content">
        {% if model %}
        <h3 style="margin: 16px 0; font-size: 1rem; color: #1e293b;">Model Accuracy Analysis</h3>
        <p style="margin-bottom: 16px; font-weight: 500;">Probability of Response Coverage</p>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Records</div>
                <div class="metric-value">{{ model.total }}</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">With Probability</div>
                <div class="metric-value">{{ model.prob_exists }}</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Blank (No Probability)</div>
                <div class="metric-value">{{ model.prob_blank }}</div>
            </div>
        </div>

        {% if model.breakdown and model.breakdown|length > 0 %}
        <h3 style="margin: 24px 0 16px 0; font-size: 1rem; color: #1e293b;">Model Accuracy by Profile Category</h3>
        <p style="color: #64748b; margin-bottom: 16px;">Comparing Model Probability vs Actual Response Rate for each Profile_Cat_Prob_Resp</p>

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Profile Category</th>
                            <th>Count</th>
                            <th>Model Probability</th>
                            <th>Actual Response Rate</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for b in model.breakdown %}
                        <tr>
                            <td>{{ b.profile }}</td>
                            <td>{{ b.count }}</td>
                            <td>{{ b.model_prob }}%</td>
                            <td>{{ b.actual_rate }}%</td>
                            <td style="color: {% if b.difference >= 0 %}#10b981{% else %}#ef4444{% endif %}">
                                {% if b.difference >= 0 %}+{% endif %}{{ b.difference }}%
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Model vs Actual Chart -->
        <h3 style="margin: 24px 0 16px 0; font-size: 1rem; color: #1e293b;">Model vs Actual Comparison Chart</h3>
        <div class="chart-container">
            <div id="model-accuracy-chart"></div>
        </div>

        <script>
        var modelAccuracyOptions = {
            series: [
                { name: 'Model Probability', data: [{% for b in model.breakdown %}{{ b.model_prob }}{% if not loop.last %}, {% endif %}{% endfor %}] },
                { name: 'Actual Response Rate', data: [{% for b in model.breakdown %}{{ b.actual_rate }}{% if not loop.last %}, {% endif %}{% endfor %}] }
            ],
            chart: { type: 'bar', height: 400 },
            plotOptions: { bar: { horizontal: false, columnWidth: '55%', borderRadius: 4 } },
            colors: ['#6366f1', '#10b981'],
            dataLabels: {
                enabled: true,
                formatter: function(val) { return val + '%'; },
                style: { fontSize: '10px' }
            },
            xaxis: {
                categories: [{% for b in model.breakdown %}'{{ b.profile[:25] }}...'{% if not loop.last %}, {% endif %}{% endfor %}],
                labels: { rotate: -45, style: { fontSize: '10px' } }
            },
            yaxis: { title: { text: 'Rate (%)' } },
            legend: { position: 'top' }
        };
        new ApexCharts(document.getElementById('model-accuracy-chart'), modelAccuracyOptions).render();
        </script>
        {% else %}
        <p style="color: #64748b;">No records with Probability_of_Response found in the selected date range.</p>
        {% endif %}
        {% else %}
        <div class="empty-state">
            <p>No data available for the selected date range.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab 5: Blank Response -->
    <div id="tab-blank" class="tab-content">
        <h3 style="margin: 16px 0; font-size: 1rem; color: #1e293b;">Blank Response Records</h3>
        <p style="color: #64748b; margin-bottom: 16px;">Showing records where Call_Status = 'Not Done' AND WhatsApp Response is blank</p>

        {% if blank and blank|length > 0 %}
        <div class="metric-card" style="display: inline-block; margin-bottom: 16px;">
            <div class="metric-label">Total Blank Response Records</div>
            <div class="metric-value">{{ blank|length }}</div>
        </div>

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Email ID</th>
                            <th>Sales Agent</th>
                            <th>Event Date</th>
                            <th>Phone Number</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in blank %}
                        <tr>
                            <td>{{ r.email }}</td>
                            <td>{{ r.agent }}</td>
                            <td>{{ r.date }}</td>
                            <td>{{ r.phone }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div style="background: #ecfdf5; padding: 16px; border-radius: 8px; color: #065f46;">
            No records found with Not Done status and blank WhatsApp response.
        </div>
        {% endif %}
    </div>
</div>

<!-- Calculation Logic Section -->
<div class="logic-section">
    <button class="logic-toggle" onclick="toggleLogic(this)">
        <span class="toggle-icon">&#9660;</span>
        <span>How are these metrics calculated?</span>
    </button>
    <div class="logic-content" style="display:none;">
        <div class="data-source">
            <strong>Data Source:</strong> weekly_attendance_status-Grid view.csv (attendance data)
        </div>

        <h4>Important Filter</h4>
        <p>All metrics on this slide <strong>exclude</strong> records where <code>Source = 'Inbound_Direct'</code>.</p>

        <h4>Calls Booked</h4>
        <p>Total calls scheduled (excluding Inbound_Direct source).</p>
        <div class="formula">Calls Booked = COUNT(all attendance records where Source ≠ 'Inbound_Direct')</div>

        <h4>Response Categories</h4>
        <ul>
            <li><strong>Yes:</strong> Call_Status = 'Done' OR WhatsApp_Response = 'In Touch' OR 'Confirmed Attendance'</li>
            <li><strong>No:</strong> WhatsApp_Response = 'No Response'</li>
            <li><strong>Blank:</strong> WhatsApp_Response is empty/null</li>
        </ul>

        <h4>Response Rate</h4>
        <div class="formula">Response Rate = (Responses Yes / Calls Booked) × 100</div>

        <h4>Attendance Rate</h4>
        <div class="formula">Attendance Rate = (Calls Done / Calls Booked) × 100</div>

        <h4>Agent Data</h4>
        <p>Same metrics broken down by individual agent.</p>

        <h4>Model Accuracy (Profile Category)</h4>
        <p>Compares predicted probability of response vs actual response rate.</p>
        <ul>
            <li><strong>Model Probability:</strong> Value from <code>Probability_of_Response</code> field</li>
            <li><strong>Actual Response Rate:</strong> Calculated from actual responses per category</li>
            <li><strong>Difference:</strong> Actual Rate - Model Probability</li>
        </ul>

        <h4>Blank Response Records</h4>
        <p>Records where a response should have been recorded but wasn't.</p>
        <div class="formula">Filter: Call_Status = 'Not Done' AND WhatsApp_Response is blank</div>
    </div>
</div>
